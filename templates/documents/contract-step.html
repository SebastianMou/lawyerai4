{% extends '../base.html' %}
{% load static %}

{% block content %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/7.1.2/tinymce.min.js" referrerpolicy="origin"></script>

<style>
    .fa-question-circle {
        color: gray;
        transition: color 0.3s ease; /* Smooth transition */
    }

    .fa-question-circle:hover {
        color: black; /* Change color on hover */
    }

    .info-icon {
        cursor: pointer;
        color: #0d6efd;
    }

    .info-icon:hover + .tooltip-text {
        display: block;
    }

    .tooltip-text {
        display: none;
        position: absolute;
        padding: 10px;
        border-radius: 5px;
        z-index: 10;
        font-size: 0.9em;
        max-width: 250px;
        box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.633);
    }

    /* Step indicator container */
    #stepIndicators {
        margin: 20px 0;
        position: relative;
        width: 100%;
    }

    /* The connecting line */
    #stepIndicators::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 2px;
        background-color: #ddd; /* Inactive line color */
        z-index: 0;
    }

    /* Step indicator circles */
    .step-indicator {
        position: relative;
        width: 30px;
        height: 30px;
        border: 2px solid #ddd;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 14px;
        background-color: #f8f9fa;
        color: #6c757d;
        z-index: 1;
        transition: all 0.3s ease;
    }

    .step-indicator.active {
        border-color: #0d6efd;
        background-color: #0d6efd;
        color: white;
        font-weight: bold;
    }

    /* Line segment for active sections */
    .step-indicator.active::before {
        content: '';
        position: absolute;
        top: 50%;
        left: -50%;
        width: 100%;
        height: 2px;
        background-color: #0d6efd; /* Active line color */
        z-index: -1;
    }

    .step-indicator:first-child.active::before {
        content: none; /* No line before the first circle */
    }

    .hidden {
        display: none !important;
    }

    .glass-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.7); /* White background with transparency */
        backdrop-filter: blur(5px); /* Frosted glass effect */
        z-index: 9999; /* Position it above the TinyMCE editor and toolbar */
        border-radius: 5px; /* Smooth corners */
        pointer-events: none; /* Allow clicks to pass through this overlay */
    }

    .glass-overlay.active {
        pointer-events: all; /* Prevent clicks on the editor */
    }

    .glass-overlay.hidden {
        display: none; /* Completely hide the overlay */
    }

    .editor-container {
        position: relative; /* So the overlay can be positioned relative to it */
    }
</style>

<div class="container">
    <!-- <p>Complete los campos a continuación para generar un contrato profesional paso a paso.</p> -->

    <div class="container" style="margin-top: 25px;">
        <div class="d-flex justify-content-between align-items-center mb-3 position-relative" id="stepIndicators">
            <!-- Dynamically generated indicators -->
        </div>

        <!-- Carousel -->
        <div id="contractCarousel" class="carousel slide" data-bs-ride="false" data-bs-interval="false">
            <div class="carousel-inner">
                
                <form id="contractForm" novalidate>

                    <!-- Step 1 (title) -->
                    <div class="carousel-item active">
                        <div class="text-end">
                            <button type="button" class="btn btn-primary" style="border-radius: 50px;" data-bs-target="#contractCarousel" data-bs-slide="next">
                                Siguiente <i class="align-middle me-2 fas fa-fw fa-arrow-right"></i>
                            </button>
                        </div>
                        
                        <div class="mb-3">
                            <label for="title" class="form-label">Título del Contrato:</label>
                            <input type="text" id="title" name="title" class="form-control" maxlength="255" required placeholder="Ejemplo: Contrato de Arrendamiento de Vivienda">
                        </div>
                        
                        <!-- Suggestion box -->
                        <div id="suggestionBox" style="display: none; font-style: italic; color: gray;">
                            <!-- Suggestions will be dynamically added here -->
                        </div>

                    </div>

                    <!-- Step 2 (party_one_name, party_one_role) -->
                    <div class="carousel-item">
                        <div class="mb-3">
                            <div style="margin-bottom: 10px;" class="row">
                                <div class="col">
                                    <button type="button" class="btn btn-secondary" style="margin-right: 5px; border-radius: 50px;" data-bs-target="#contractCarousel" data-bs-slide="prev">
                                        <i class="align-middle me-2 fas fa-fw fa-arrow-left"></i> Anterior
                                    </button>
                                </div>
                                <div class="col text-end">
                                    <button type="button" class="btn btn-primary" style="border-radius: 50px;" data-bs-target="#contractCarousel" data-bs-slide="next">
                                        Siguiente <i class="align-middle me-2 fas fa-fw fa-arrow-right"></i>
                                    </button>    
                                </div>
                            </div>
                            <label for="party_one_name" class="form-label">Nombre de la Primera Parte:</label> 
                            <i class="align-middle me-2 fas fa-fw fa-question-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Ingrese el nombre completo de la primera parte del contrato. Puede ser una persona o empresa."></i>

                            <input type="text" id="party_one_name" name="party_one_name" class="form-control" maxlength="255" placeholder="Ejemplo: Sienna Moss o Compañía XYZ" style="border: none; border-bottom: 1px solid gray; background: none; border-radius: 0; outline: none; box-shadow: none;">
                        </div>
                        <br>
                        <div class="mb-3">
                            <label for="party_one_role" class="form-label">Rol de la Primera Parte: (opcional)</label> 
                            <i class="align-middle me-2 fas fa-fw fa-question-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Indique el rol o función de la primera parte en este contrato (por ejemplo, Propietario)."></i>

                            <input type="text" id="party_one_role" name="party_one_role" class="form-control" maxlength="255" placeholder="Ejemplo: Propietario o Proveedor de Servicios" style="border: none; border-bottom: 1px solid gray; background: none; border-radius: 0; outline: none; box-shadow: none;">
                        </div>
                    </div>

                    <!-- Step 3 (party_two_name, party_two_role) -->
                    <div class="carousel-item">
                        <div class="mb-3">
                            <div style="margin-bottom: 10px;" class="row">
                                <div class="col">
                                    <button type="button" class="btn btn-secondary" style="margin-right: 5px; border-radius: 50px;" data-bs-target="#contractCarousel" data-bs-slide="prev">
                                        <i class="align-middle me-2 fas fa-fw fa-arrow-left"></i> Anterior
                                    </button>
                                </div>
                                <div class="col text-end">
                                    <button type="button" class="btn btn-primary" style="border-radius: 50px;" data-bs-target="#contractCarousel" data-bs-slide="next">
                                        Siguiente <i class="align-middle me-2 fas fa-fw fa-arrow-right"></i>
                                    </button>    
                                </div>
                            </div>
                            <label for="party_two_name" class="form-label">Nombre de la Segunda Parte:</label> 
                            <i class="align-middle me-2 fas fa-fw fa-question-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Ingrese el nombre completo de la segunda parte del contrato. Puede ser una persona o empresa."></i>

                            <input type="text" id="party_two_name" name="party_two_name" class="form-control" maxlength="255" placeholder="Ejemplo: María López o Compañía XYZ" style="border: none; border-bottom: 1px solid gray; background: none; border-radius: 0; outline: none; box-shadow: none;">
                        </div>
                        <br>
                        <div class="mb-3">
                            <label for="party_two_role" class="form-label">Rol de la Segunda Parte: (opcional)</label> 
                            <i class="align-middle me-2 fas fa-fw fa-question-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Indique el rol o función de la segunda parte en este contrato (por ejemplo, Inquilino)."></i>

                            <input type="text" id="party_two_role" name="party_two_role" class="form-control" maxlength="255" placeholder="Ejemplo: Inquilino o Comprador" style="border: none; border-bottom: 1px solid gray; background: none; border-radius: 0; outline: none; box-shadow: none;">
                        </div>
                    </div>

                    <!-- Step 4 (effective_date) -->
                    <div class="carousel-item">
                        <div class="mb-3">
                            <div style="margin-bottom: 10px;" class="row">
                                <div class="col">
                                    <button type="button" class="btn btn-secondary" style="margin-right: 5px; border-radius: 50px;" data-bs-target="#contractCarousel" data-bs-slide="prev">
                                        <i class="align-middle me-2 fas fa-fw fa-arrow-left"></i> Anterior
                                    </button>
                                </div>
                                <div class="col text-end">
                                    <button type="button" class="btn btn-primary" style="border-radius: 50px;" data-bs-target="#contractCarousel" data-bs-slide="next">
                                        Siguiente <i class="align-middle me-2 fas fa-fw fa-arrow-right"></i>
                                    </button>    
                                </div>
                            </div>
                            <label for="effective_date" class="form-label">Fecha de Inicio:</label> 
                            <i class="align-middle me-2 fas fa-fw fa-question-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Seleccione la fecha en que este contrato entrará en vigor."></i>

                            <input type="date" id="effective_date" name="effective_date" class="form-control" style="border: none; border-bottom: 1px solid gray; background: none; border-radius: 0; outline: none; box-shadow: none;">

                        </div>
                    </div>

                    <!-- Step 5 (purpose) -->
                    <div class="carousel-item">
                        <div class="mb-3">
                            <div style="margin-bottom: 10px;" class="row">
                                <div class="col">
                                    <button type="button" class="btn btn-secondary" style="margin-right: 5px; border-radius: 50px;" data-bs-target="#contractCarousel" data-bs-slide="prev">
                                        <i class="align-middle me-2 fas fa-fw fa-arrow-left"></i> Anterior
                                    </button>
                                </div>
                                <div class="col text-end">
                                    <button type="button" class="btn btn-primary" style="border-radius: 50px;" data-bs-target="#contractCarousel" data-bs-slide="next">
                                        Siguiente <i class="align-middle me-2 fas fa-fw fa-arrow-right"></i>
                                    </button>    
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="purpose" class="form-label">Propósito o Descripción:</label>
                                <i class="align-middle me-2 fas fa-fw fa-question-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Ingrese una descripción clara y concisa del propósito de este contrato o documento. Puede incluir los objetivos principales o razones para su creación."></i>
                                <textarea id="purpose" name="purpose" class="form-control" placeholder="Ejemplo: Este contrato formaliza la relación laboral entre el empleador y el empleado, estableciendo los términos, condiciones y obligaciones de ambas partes, incluyendo las responsabilidades laborales, los beneficios, y el cumplimiento de las leyes aplicables."></textarea>
                            
                                <button class="btn btn-primary form-control" type="button" style="margin-top: 12px; border-radius: 50px;" onclick="generateAIText('purpose', event)">
                                    Reescribir Párrafo
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-stars" viewBox="0 0 16 16">
                                        <path d="M7.657 6.247c.11-.33.576-.33.686 0l.645 1.937a2.89 2.89 0 0 0 1.829 1.828l1.936.645c.33.11.33.576 0 .686l-1.937.645a2.89 2.89 0 0 0-1.828 1.829l-.645 1.936a.361.361 0 0 1-.686 0l-.645-1.937a2.89 2.89 0 0 0-1.828-1.828l-1.937-.645a.361.361 0 0 1 0-.686l1.937-.645a2.89 2.89 0 0 0 1.828-1.828zM3.794 1.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387A1.73 1.73 0 0 0 4.593 5.69l-.387 1.162a.217.217 0 0 1-.412 0L3.407 5.69A1.73 1.73 0 0 0 2.31 4.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387A1.73 1.73 0 0 0 3.407 2.31zM10.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.16 1.16 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.16 1.16 0 0 0-.732-.732L9.1 2.137a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732z"/>
                                      </svg>
                                </button>
                            
                                <div id="purpose-ai-output" class="mt-2" style="font-style: italic; color: rgb(59, 59, 59); background-color: white; border-radius: 15px; padding: 10px; border: 2px solid rgba(128, 128, 128, 0.45);">
                                    El texto generado por IA aparecerá aquí.
                                </div>

                            </div>

                        </div>
                    </div>

                    <!-- Step 6 (obligations) -->
                    <div class="carousel-item">
                        <div class="mb-3">
                            <div style="margin-bottom: 10px;" class="row">
                                <div class="col">
                                    <button type="button" class="btn btn-secondary" style="margin-right: 5px; border-radius: 50px;" data-bs-target="#contractCarousel" data-bs-slide="prev">
                                        <i class="align-middle me-2 fas fa-fw fa-arrow-left"></i> Anterior
                                    </button>
                                </div>
                                <div class="col text-end">
                                    <button type="button" class="btn btn-primary" style="border-radius: 50px;" data-bs-target="#contractCarousel" data-bs-slide="next">
                                        Siguiente <i class="align-middle me-2 fas fa-fw fa-arrow-right"></i>
                                    </button>    
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="obligations" class="form-label">Obligaciones y Responsabilidades:</label>
                                <i class="align-middle me-2 fas fa-fw fa-question-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Describa las obligaciones y responsabilidades de las partes involucradas en este contrato. Esto puede incluir acciones, deberes o compromisos específicos que cada parte debe cumplir."></i>
                                <textarea id="obligations" name="obligations" class="form-control" placeholder="Ejemplo: El empleador deberá proporcionar las herramientas necesarias para el desempeño del trabajo, mientras que el empleado deberá cumplir con sus responsabilidades laborales según lo indicado en este contrato."></textarea>
                            
                                <button class="btn btn-primary form-control" type="button" style="margin-top: 12px; border-radius: 50px;" onclick="generateAIText('obligations', event)">
                                    Reescribir Párrafo
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-stars" viewBox="0 0 16 16">
                                        <path d="M7.657 6.247c.11-.33.576-.33.686 0l.645 1.937a2.89 2.89 0 0 0 1.829 1.828l1.936.645c.33.11.33.576 0 .686l-1.937.645a2.89 2.89 0 0 0-1.828 1.829l-.645 1.936a.361.361 0 0 1-.686 0l-.645-1.937a2.89 2.89 0 0 0-1.828-1.828l-1.937-.645a.361.361 0 0 1 0-.686l1.937-.645a2.89 2.89 0 0 0 1.828-1.828zM3.794 1.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387A1.73 1.73 0 0 0 4.593 5.69l-.387 1.162a.217.217 0 0 1-.412 0L3.407 5.69A1.73 1.73 0 0 0 2.31 4.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387A1.73 1.73 0 0 0 3.407 2.31zM10.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.16 1.16 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.16 1.16 0 0 0-.732-.732L9.1 2.137a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732z"/>
                                      </svg>
                                </button>
                            
                                <div id="obligations-ai-output" class="mt-2" style="font-style: italic; color: rgb(59, 59, 59); background-color: white; border-radius: 15px; padding: 10px; border: 2px solid rgba(128, 128, 128, 0.45);">
                                    El texto generado por IA aparecerá aquí.
                                </div>
                            </div>
                            
                        </div>
                    </div>

                    <!-- Step 7 (payment_terms) -->
                    <div class="carousel-item">
                        <div class="mb-3">
                            <div style="margin-bottom: 10px;" class="row">
                                <div class="col">
                                    <button type="button" class="btn btn-secondary" style="margin-right: 5px; border-radius: 50px;" data-bs-target="#contractCarousel" data-bs-slide="prev">
                                        <i class="align-middle me-2 fas fa-fw fa-arrow-left"></i> Anterior
                                    </button>
                                </div>
                                <div class="col text-end">
                                    <button type="button" class="btn btn-primary" style="border-radius: 50px;" data-bs-target="#contractCarousel" data-bs-slide="next">
                                        Siguiente <i class="align-middle me-2 fas fa-fw fa-arrow-right"></i>
                                    </button>    
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="payment_terms" class="form-label">Términos de Pago: (Opcional)</label> <small>Si el contrato no involucra transacciones financieras (por ejemplo, acuerdos no monetarios, NDAs), esto puede omitirse.</small>
                                <i class="align-middle me-2 fas fa-fw fa-question-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Especifique los términos de pago, como montos y fechas de vencimiento (opcional)."></i>

                                <textarea id="payment_terms" name="payment_terms" class="form-control" rows="4" placeholder="Ejemplo: El inquilino pagará $10,000 MXN mensuales el primer día de cada mes."></textarea>

                                <button class="btn btn-primary form-control" style="border-radius: 50px; margin-top: 12px;" onclick="generateAIText('payment_terms', event)">
                                    Reescribir Párrafo 
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-stars" viewBox="0 0 16 16">
                                        <path d="M7.657 6.247c.11-.33.576-.33.686 0l.645 1.937a2.89 2.89 0 0 0 1.829 1.828l1.936.645c.33.11.33.576 0 .686l-1.937.645a2.89 2.89 0 0 0-1.828 1.829l-.645 1.936a.361.361 0 0 1-.686 0l-.645-1.937a2.89 2.89 0 0 0-1.828-1.828l-1.937-.645a.361.361 0 0 1 0-.686l1.937-.645a2.89 2.89 0 0 0 1.828-1.828zM3.794 1.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387A1.73 1.73 0 0 0 4.593 5.69l-.387 1.162a.217.217 0 0 1-.412 0L3.407 5.69A1.73 1.73 0 0 0 2.31 4.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387A1.73 1.73 0 0 0 3.407 2.31zM10.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.16 1.16 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.16 1.16 0 0 0-.732-.732L9.1 2.137a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732z"/>
                                    </svg>
                                </button>
                                
                                <div id="payment_terms-ai-output" class="mt-2" style="font-style: italic; color: rgb(59, 59, 59); background-color: white; border-radius: 15px; padding: 10px; border: 2px solid rgba(128, 128, 128, 0.45);">
                                    El texto generado por IA aparecerá aquí.
                                </div>
                            </div>
                            
                        </div>
                    </div>

                    <!-- Step 8 (duration) -->
                    <div class="carousel-item">
                        <div class="mb-3">
                            <div style="margin-bottom: 10px;" class="row">
                                <div class="col">
                                    <button type="button" class="btn btn-secondary" style="margin-right: 5px; border-radius: 50px;" data-bs-target="#contractCarousel" data-bs-slide="prev">
                                        <i class="align-middle me-2 fas fa-fw fa-arrow-left"></i> Anterior
                                    </button>
                                </div>
                                <div class="col text-end">
                                    <button type="button" class="btn btn-primary" style="border-radius: 50px;" data-bs-target="#contractCarousel" data-bs-slide="next">
                                        Siguiente <i class="align-middle me-2 fas fa-fw fa-arrow-right"></i>
                                    </button>    
                                </div>
                            </div>
                            <label for="duration" class="form-label">Duración: (Opcional)</label><small>Algunos contratos (por ejemplo, acuerdos indefinidos) no requieren una duración específica.</small>
                            <i class="align-middle me-2 fas fa-fw fa-question-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Indique la duración del contrato (por ejemplo, 12 meses)."></i>

                            <input type="text" id="duration" name="duration" class="form-control" maxlength="255" placeholder="Ejemplo: 12 meses" style="border: none; border-bottom: 1px solid gray; background: none; border-radius: 0; outline: none; box-shadow: none;">
                        </div>
                    </div>

                    <!-- Step 9 (termination_clause) -->
                    <div class="carousel-item">
                        <div class="mb-3">
                            <div style="margin-bottom: 10px;" class="row">
                                <div class="col">
                                    <button type="button" class="btn btn-secondary" style="margin-right: 5px; border-radius: 50px;" data-bs-target="#contractCarousel" data-bs-slide="prev">
                                        <i class="align-middle me-2 fas fa-fw fa-arrow-left"></i> Anterior
                                    </button>
                                </div>
                                <div class="col text-end">
                                    <button type="button" class="btn btn-primary" style="border-radius: 50px;" data-bs-target="#contractCarousel" data-bs-slide="next">
                                        Siguiente <i class="align-middle me-2 fas fa-fw fa-arrow-right"></i>
                                    </button>    
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="termination_clause" class="form-label">Cláusula de Terminación:</label><small>Aunque se recomienda para mayor claridad, algunos contratos (por ejemplo, transacciones únicas) pueden no necesitar condiciones de terminación.</small>
                                <i class="align-middle me-2 fas fa-fw fa-question-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Defina las condiciones bajo las cuales este contrato puede ser terminado."></i>
    
                                <textarea id="termination_clause" name="termination_clause" class="form-control" rows="4" placeholder="Ejemplo: El contrato podrá ser terminado con un aviso de 30 días."></textarea>
    
                                <button class="btn btn-primary form-control" style="border-radius: 50px; margin-top: 12px;" onclick="generateAIText('termination_clause', event)">
                                    Reescribir Párrafo 
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-stars" viewBox="0 0 16 16">
                                        <path d="M7.657 6.247c.11-.33.576-.33.686 0l.645 1.937a2.89 2.89 0 0 0 1.829 1.828l1.936.645c.33.11.33.576 0 .686l-1.937.645a2.89 2.89 0 0 0-1.828 1.829l-.645 1.936a.361.361 0 0 1-.686 0l-.645-1.937a2.89 2.89 0 0 0-1.828-1.828l-1.937-.645a.361.361 0 0 1 0-.686l1.937-.645a2.89 2.89 0 0 0 1.828-1.828zM3.794 1.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387A1.73 1.73 0 0 0 4.593 5.69l-.387 1.162a.217.217 0 0 1-.412 0L3.407 5.69A1.73 1.73 0 0 0 2.31 4.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387A1.73 1.73 0 0 0 3.407 2.31zM10.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.16 1.16 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.16 1.16 0 0 0-.732-.732L9.1 2.137a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732z"/>
                                      </svg>
                                </button>

                                <div id="termination_clause-ai-output" class="mt-2" style="font-style: italic; color: rgb(59, 59, 59); background-color: white; border-radius: 15px; padding: 10px; border: 2px solid rgba(128, 128, 128, 0.45);">
                                    El texto generado por IA aparecerá aquí.
                                </div>
                            </div>
                            
                        </div>
                    </div>

                    <!-- Step 10 (confidentiality_clause) -->
                    <div class="carousel-item">
                        <div class="mb-3">
                            <div style="margin-bottom: 10px;" class="row">
                                <div class="col">
                                    <button type="button" class="btn btn-secondary" style="margin-right: 5px; border-radius: 50px;" data-bs-target="#contractCarousel" data-bs-slide="prev">
                                        <i class="align-middle me-2 fas fa-fw fa-arrow-left"></i> Anterior
                                    </button>
                                </div>
                                <div class="col text-end">
                                    <button type="button" class="btn btn-primary" style="border-radius: 50px;" data-bs-target="#contractCarousel" data-bs-slide="next">
                                        Siguiente <i class="align-middle me-2 fas fa-fw fa-arrow-right"></i>
                                    </button>    
                                </div>
                            </div>
                    
                            <div class="mb-3">
                                <label for="confidentiality_clause" class="form-label">Cláusula de Confidencialidad:</label>
                                <i class="align-middle me-2 fas fa-fw fa-question-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Describa cualquier requisito de confidencialidad que aplique a este contrato (opcional)."></i>
                    
                                <!-- Toggle Switch -->
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="confidentiality_toggle">
                                    <label class="form-check-label" for="confidentiality_toggle">Sí, incluir la cláusula de confidencialidad</label>
                                </div>
                    
                                <!-- TinyMCE Editor Container -->
                                <div class="editor-container">
                                    <!-- Frosted Glass Overlay -->
                                    <div id="glass_overlay" class="glass-overlay active"></div> <!-- This overlay is active by default -->
                                    
                                    <!-- TinyMCE Textarea -->
                                    <textarea id="confidentiality_clause" name="confidentiality_clause" class="form-control" rows="4" placeholder="Ejemplo: Ambas partes acuerdan mantener la información confidencial."></textarea>
                                </div>
                    
                                <button id="confidentiality_ai_button" class="btn btn-primary form-control hidden" style="border-radius: 50px; margin-top: 12px;" onclick="generateAIText('confidentiality_clause', event)">
                                    Reescribir Párrafo 
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-stars" viewBox="0 0 16 16">
                                        <path d="M7.657 6.247c.11-.33.576-.33.686 0l.645 1.937a2.89 2.89 0 0 0 1.829 1.828l1.936.645c.33.11.33.576 0 .686l-1.937.645a2.89 2.89 0 0 0-1.828 1.829l-.645 1.936a.361.361 0 0 1-.686 0l-.645-1.937a2.89 2.89 0 0 0-1.828-1.828l-1.937-.645a.361.361 0 0 1 0-.686l1.937-.645a2.89 2.89 0 0 0 1.828-1.828z"/>
                                    </svg>
                                </button>
                    
                                <div id="confidentiality_clause-ai-output" class="mt-2 hidden" style="font-style: italic; color: rgb(59, 59, 59); background-color: white; border-radius: 15px; padding: 10px; border: 2px solid rgba(128, 128, 128, 0.45);">
                                    El texto generado por IA aparecerá aquí.
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Step 11 (dispute_resolution) -->
                    <div class="carousel-item">
                        <div class="mb-3">
                            <div style="margin-bottom: 10px;" class="row">
                                <div class="col">
                                    <button type="button" class="btn btn-secondary" style="margin-right: 5px; border-radius: 50px;" data-bs-target="#contractCarousel" data-bs-slide="prev">
                                        <i class="align-middle me-2 fas fa-fw fa-arrow-left"></i> Anterior
                                    </button>
                                </div>
                                <div class="col text-end">
                                    <button type="button" class="btn btn-primary" style="border-radius: 50px;" data-bs-target="#contractCarousel" data-bs-slide="next">
                                        Siguiente <i class="align-middle me-2 fas fa-fw fa-arrow-right"></i>
                                    </button>    
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="dispute_resolution" class="form-label">Resolución de Disputas:</label>
                                <i class="align-middle me-2 fas fa-fw fa-question-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Especifique cómo se resolverán las disputas relacionadas con este contrato (por ejemplo, arbitraje)."></i>

                                <!-- Toggle Switch -->
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="dispute_resolution_toggle">
                                    <label class="form-check-label" for="dispute_resolution_toggle">Sí, incluir la cláusula de resolución de disputas</label>
                                </div>

                                <!-- TinyMCE Editor Container -->
                                <div class="editor-container">
                                    <!-- Frosted Glass Overlay -->
                                    <div id="glass_overlay_dispute_resolution" class="glass-overlay active"></div> <!-- This overlay is active by default -->
                                    
                                    <!-- TinyMCE Textarea -->
                                    <textarea id="dispute_resolution" name="dispute_resolution" class="form-control" rows="4" placeholder="Ejemplo: Las disputas se resolverán mediante arbitraje."></textarea>
                                </div>

                                <button id="dispute_resolution_ai_button" class="btn btn-primary form-control hidden" style="border-radius: 50px; margin-top: 12px;" onclick="generateAIText('dispute_resolution', event)">
                                    Reescribir Párrafo
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-stars" viewBox="0 0 16 16">
                                        <path d="M7.657 6.247c.11-.33.576-.33.686 0l.645 1.937a2.89 2.89 0 0 0 1.829 1.828l1.936.645c.33.11.33.576 0 .686l-1.937.645a2.89 2.89 0 0 0-1.828 1.829l-.645 1.936a.361.361 0 0 1-.686 0l-.645-1.937a2.89 2.89 0 0 0-1.828-1.828l-1.937-.645a.361.361 0 0 1 0-.686l1.937-.645a2.89 2.89 0 0 0 1.828-1.828z"/>
                                    </svg>
                                </button>

                                <div id="dispute_resolution-ai-output" class="mt-2 hidden" style="font-style: italic; color: rgb(59, 59, 59); background-color: white; border-radius: 15px; padding: 10px; border: 2px solid rgba(128, 128, 128, 0.45);">
                                    El texto generado por IA aparecerá aquí.
                                </div>
                            </div>
                        </div>
                    </div>


                    <!-- Step 12 (penalties_for_breach) -->
                    <div class="carousel-item">
                        <div class="mb-3">
                            <!-- Navigation Buttons -->
                            <div style="margin-bottom: 10px;" class="row">
                                <div class="col">
                                    <button type="button" class="btn btn-secondary" style="margin-right: 5px; border-radius: 50px;" data-bs-target="#contractCarousel" data-bs-slide="prev">
                                        <i class="align-middle me-2 fas fa-fw fa-arrow-left"></i> Anterior
                                    </button>
                                </div>
                                <div class="col text-end">
                                    <button type="button" class="btn btn-primary" style="border-radius: 50px;" data-bs-target="#contractCarousel" data-bs-slide="next">
                                        Siguiente <i class="align-middle me-2 fas fa-fw fa-arrow-right"></i>
                                    </button>    
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="penalties_for_breach" class="form-label">Penalizaciones por Incumplimiento:</label>
                                <i class="align-middle me-2 fas fa-fw fa-question-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Defina las penalizaciones aplicables en caso de incumplimiento del contrato."></i>

                                <!-- Toggle Switch -->
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="penalties_for_breach_toggle">
                                    <label class="form-check-label" for="penalties_for_breach_toggle">Sí, incluir la cláusula de penalización por incumplimiento</label>
                                </div>

                                <!-- TinyMCE Editor Container -->
                                <div class="editor-container">
                                    <!-- Frosted Glass Overlay -->
                                    <div id="glass_overlay_penalties_for_breach" class="glass-overlay active"></div> <!-- This overlay is active by default -->
                                    
                                    <!-- TinyMCE Textarea -->
                                    <textarea id="penalties_for_breach" name="penalties_for_breach" class="form-control" rows="4" placeholder="Ejemplo: El incumplimiento resultará en una multa del 10%."></textarea>
                                </div>

                                <button id="penalties_for_breach_ai_button" class="btn btn-primary form-control hidden" style="border-radius: 50px; margin-top: 12px;" onclick="generateAIText('penalties_for_breach', event)">
                                    Reescribir Párrafo 
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-stars" viewBox="0 0 16 16">
                                        <path d="M7.657 6.247c.11-.33.576-.33.686 0l.645 1.937a2.89 2.89 0 0 0 1.829 1.828l1.936.645c.33.11.33.576 0 .686l-1.937.645a2.89 2.89 0 0 0-1.828 1.829l-.645 1.936a.361.361 0 0 1-.686 0l-.645-1.937a2.89 2.89 0 0 0-1.828-1.828l-1.937-.645a.361.361 0 0 1 0-.686l1.937-.645a2.89 2.89 0 0 0 1.828-1.828z"/>
                                    </svg>
                                </button>

                                <div id="penalties_for_breach-ai-output" class="mt-2 hidden" style="font-style: italic; color: rgb(59, 59, 59); background-color: white; border-radius: 15px; padding: 10px; border: 2px solid rgba(128, 128, 128, 0.45);">
                                    El texto generado por IA aparecerá aquí.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 13 (notary_required, notarization) -->
                    <div class="carousel-item">
                        <div class="mb-3">
                            <div style="margin-bottom: 10px;" class="row">
                                <div class="col">
                                    <button type="button" class="btn btn-secondary" style="margin-right: 5px; border-radius: 50px;" data-bs-target="#contractCarousel" data-bs-slide="prev">
                                        <i class="align-middle me-2 fas fa-fw fa-arrow-left"></i> Anterior
                                    </button>
                                </div>
                                <div class="col text-end">
                                    <a href="{% url 'contract_check_basis_view' contract.pk %}" type="button" id="finalizeButton" class="btn btn-success mt-2" style="border-radius: 50px;">
                                        Finalizar <i class="align-middle me-2 fas fa-fw fa-arrow-right"></i>
                                    </a>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="notarization_toggle" class="form-label">¿Penalidades por incumplimiento?</label>
                                <i class="align-middle me-2 fas fa-fw fa-question-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Marque esta opción si este contrato requiere la presencia de un notario."></i>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="notarization_toggle" name="notarization_required">
                                    <label class="form-check-label" for="notarization_toggle">Sí, se requiere notaría</label>
                                </div>

                                <!-- Textarea for Notarization Template -->
                                <textarea id="notarization" name="notarization" class="form-control hidden" rows="4" placeholder="Ejemplo: notarization."></textarea>
                            
                            </div>

                        </div>
                    </div>

                </form>
            </div>
        </div>
    </div>
    
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", async function () {
        // Extract the contract ID from the URL
        const contractId = window.location.pathname.split("/")[2];
        console.log("Contract ID:", contractId);

        let contractData = {}; // Object to store contract data

        try {
            // Fetch contract details using the dynamic endpoint
            const response = await fetch(`http://127.0.0.1:7000/api/contract-steps-project-detail/${contractId}/`);
            if (response.ok) {
                contractData = await response.json();

                // Populate non-TinyMCE fields
                document.getElementById("title").value = contractData.title || "";
                document.getElementById("party_one_name").value = contractData.party_one_name || "";
                document.getElementById("party_one_role").value = contractData.party_one_role || "";
                document.getElementById("party_two_name").value = contractData.party_two_name || "";
                document.getElementById("party_two_role").value = contractData.party_two_role || "";
                document.getElementById("effective_date").value = contractData.effective_date || "";
                document.getElementById("effective_date").value = contractData.effective_date || "";
                document.getElementById("duration").value = contractData.duration || "";

                
                document.getElementById("notarization_toggle").checked = contractData.notary_required || false;
                document.getElementById("notarization").value = contractData.notarization_details || ""; // Update for notarization field

                console.log("Contract data loaded:", contractData); // Debugging to confirm data loading
            } else {
                console.error("Failed to fetch contract data. Status:", response.status);
            }
        } catch (error) {
            console.error("Error fetching contract data:", error);
        }

        // Initialize TinyMCE and populate fields when ready
        tinymce.init({
            selector: 'textarea', // Targets all <textarea> elements
            plugins: 'advlist autolink lists link image charmap print preview anchor searchreplace visualblocks code fullscreen insertdatetime media table paste help wordcount',
            toolbar: 'undo redo | formatselect | bold italic underline strikethrough | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | code fullscreen',
            menubar: 'file edit view insert format tools table help',
            language: 'es_MX',
            language_url: '/static/tinymce/langs/es_MX.js',
            language_load: true,
            setup: function (editor) {
                editor.on('init', function () {
                    console.log(`Editor ${editor.id} initialized.`);

                    // Populate TinyMCE fields once all editors are ready
                    if (editor.id === "purpose") editor.setContent(contractData.purpose || "");
                    if (editor.id === "obligations") editor.setContent(contractData.obligations || "");
                    if (editor.id === "payment_terms") editor.setContent(contractData.payment_terms || "");
                    if (editor.id === "termination_clause") editor.setContent(contractData.termination_clause || "");
                    if (editor.id === "confidentiality_clause") editor.setContent(contractData.confidentiality_clause || "");
                    if (editor.id === "dispute_resolution") editor.setContent(contractData.dispute_resolution || "");
                    if (editor.id === "penalties_for_breach") editor.setContent(contractData.penalties_for_breach || "");
                    if (editor.id === "notarization") editor.setContent(contractData.notarization || "");
                });
            }
        });

    });

    // Function to populate suggestions dynamically
    function populateSuggestions(suggestions) {
        const suggestionBox = document.getElementById("suggestionBox");
        suggestionBox.innerHTML = ""; // Clear previous suggestions

        suggestions.forEach((suggestionText, index) => {
            if (suggestionText) {
                // Create <h3> for the suggestion
                const suggestionElement = document.createElement("h4");
                suggestionElement.textContent = suggestionText;
                suggestionElement.style.cursor = "pointer"; // Add pointer cursor
                suggestionElement.onclick = function (e) {
                    e.preventDefault(); // Prevent default behavior
                    e.stopPropagation(); // Stop event propagation
                    document.getElementById("title").value = suggestionText; // Insert clicked suggestion
                    suggestionBox.style.display = "none"; // Hide suggestions
                };

                // Add the suggestion <h3> to the suggestion box
                suggestionBox.appendChild(suggestionElement);

                // Add a horizontal rule (<hr>) after each suggestion, except the last one
                if (index < suggestions.length - 1) {
                    const hr = document.createElement("hr");
                    suggestionBox.appendChild(hr);
                }
            }
        });
    }

    document.getElementById("title").addEventListener("input", async function (event) {
        const userInput = event.target.value;

        // Trigger the API call only for meaningful input
        if (userInput.length > 2) {
            try {
                const response = await fetch("http://127.0.0.1:7000/api/generate-suggestions/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCSRFToken(), // Ensure CSRF token is included
                    },
                    body: JSON.stringify({ input: userInput }),
                });

                const data = await response.json();

                if (response.ok) {
                    populateSuggestions(data.suggestions);

                    // Show the suggestion box if there are any suggestions
                    const suggestionBox = document.getElementById("suggestionBox");
                    suggestionBox.style.display = data.suggestions.length > 0 ? "block" : "none";
                } else {
                    console.error("Error generating suggestions:", data);
                }
            } catch (error) {
                console.error("Unexpected error generating suggestions:", error);
            }
        }
    });

    document.querySelectorAll(".btn[data-bs-slide='next']").forEach((button) => {
        button.addEventListener("click", async function (event) {
            tinymce.triggerSave(); // Save TinyMCE content to its underlying <textarea>

            const contractId = window.location.pathname.split("/")[2]; // Extract Contract ID
            console.log("Extracted Contract ID for Next Button:", contractId);

            if (!contractId) {
                alert("Contract ID not found in URL.");
                return;
            }

            const form = document.getElementById("contractForm");
            const formData = new FormData(form); // Gather all form data, including TinyMCE content

            try {
                const response = await fetch(`http://127.0.0.1:7000/api/contract-steps-project-update/${contractId}/`, {
                    method: "PUT",
                    headers: {
                        "X-CSRFToken": getCSRFToken(),
                    },
                    body: formData,
                });

                if (response.ok) {
                    console.log("Update successful");
                } else {
                    const errorText = await response.text();
                    console.error("Error updating contract via Next Button:", errorText);
                    alert("Failed to update contract. Check console for details.");
                }
            } catch (error) {
                console.error("Unexpected error via Next Button:", error);
                alert("An unexpected error occurred. Check console for details.");
            }
        });
    });


    async function generateAIText(fieldId, event) {
        if (event) {
            event.preventDefault(); // Prevent form submission
        }

        const editor = tinymce.get(fieldId); // Get content from TinyMCE editor (if applicable)
        const userInput = editor ? editor.getContent({ format: "text" }).trim() : ""; // Extract plain text content

        const outputDiv = document.getElementById(`${fieldId}-ai-output`);

        if (!userInput) {
            alert("Por favor, ingrese algún texto para generar el contenido.");
            return;
        }

        try {
            const response = await fetch("http://127.0.0.1:7000/api/generate-ai-text/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCSRFToken(),
                },
                body: JSON.stringify({ 
                    field: fieldId, 
                    input: userInput, 
                    title: document.getElementById("title").value.trim()
                }),
            });

            if (response.ok) {
                const data = await response.json();

                // Use Marked.js to format the generated Markdown content
                const formattedText = marked.parse(data.generated_text); // Render Markdown
                outputDiv.innerHTML = formattedText; // Render HTML into the output div

                // Add "Copy" button
                const copyButton = document.createElement("button");
                copyButton.innerHTML = '<i class="align-middle me-2 far fa-fw fa-clipboard"></i> Copiar';
                copyButton.className = "btn btn-primary mt-2 me-2";
                copyButton.style.borderRadius = "50px";
                copyButton.onclick = (e) => copyToClipboard(fieldId, e, copyButton); // Use the copy function

                // Add "Transfer" button
                const transferButton = document.createElement("button");
                transferButton.innerHTML = '<i class="align-middle me-2 fas fa-fw fa-arrow-right"></i> Transferir';
                transferButton.className = "btn btn-success mt-2";
                transferButton.style.borderRadius = "50px";
                transferButton.onclick = (e) => transferToTinyMCE(fieldId, e); // Pass the event object


                // Clear existing buttons and append new ones
                outputDiv.innerHTML = formattedText;
                outputDiv.appendChild(copyButton);
                outputDiv.appendChild(transferButton);
            } else {
                const errorData = await response.json();
                console.error("Error:", errorData);
                alert("Error al generar el texto. Consulte la consola para más detalles.");
            }
        } catch (error) {
            console.error("Unexpected error:", error);
            alert("Error inesperado. Consulte la consola para más detalles.");
        }
    }

    // Transfer AI-generated text to TinyMCE
    function transferToTinyMCE(fieldId, event) {
        if (event) {
            event.preventDefault(); // Prevent form submission or page reload
        }

        const outputDiv = document.getElementById(`${fieldId}-ai-output`);

        if (!outputDiv) {
            console.error("Output div not found!");
            return;
        }

        // Extract only the AI-generated text, ignoring buttons
        const generatedContent = Array.from(outputDiv.childNodes)
            .filter(node => node.nodeType === Node.TEXT_NODE || node.nodeType === Node.ELEMENT_NODE && node.tagName !== "BUTTON")
            .map(node => node.outerHTML || node.textContent)
            .join("");

        // Set the content in TinyMCE editor
        const editor = tinymce.get(fieldId);
        if (editor) {
            editor.setContent(generatedContent); // Set the filtered generated content
            console.log("Content transferred to TinyMCE editor.");
        } else {
            console.error("TinyMCE editor not found for the given field.");
        }
    }

    // Copy text to clipboard
    function copyToClipboard(fieldId, event, button) {
        if (event) {
            event.preventDefault(); // Prevent form submission or page reload
        }

        const outputDiv = document.getElementById(`${fieldId}-ai-output`);

        if (!outputDiv) {
            console.error("Output div not found!");
            return;
        }

        // Highlight and copy the content
        const range = document.createRange();
        range.selectNodeContents(outputDiv); // Highlight all content inside the output div
        const selection = window.getSelection();
        selection.removeAllRanges(); // Clear existing selections
        selection.addRange(range); // Highlight the range

        try {
            // Execute the copy command
            document.execCommand("copy");

            // Update the button to show success
            button.innerHTML = '<i class="align-middle me-2 fas fa-fw fa-check"></i> Copiado';
            button.classList.remove("btn-primary");
            button.classList.add("btn-success");
        } catch (err) {
            console.error("Error copying to clipboard:", err);
            alert("Error al copiar el texto. Intente de nuevo.");
        }

        // Aesthetic: Automatically unhighlight the text after a short delay
        setTimeout(() => {
            selection.removeAllRanges(); // Clear the highlight
        }, 300); // Adjust the delay as needed (300ms works well)

        // Reset the button after 2 seconds
        setTimeout(() => {
            button.innerHTML = '<i class="align-middle me-2 far fa-fw fa-clipboard"></i> Copiar';
            button.classList.remove("btn-success");
            button.classList.add("btn-primary");
        }, 2000);
    }

    // Function to retrieve CSRF token
    function getCSRFToken() {
        const name = "csrftoken";
        const cookies = document.cookie.split("; ");
        for (let cookie of cookies) {
            const [key, value] = cookie.split("=");
            if (key === name) {
                return value;
            }
        }
        return "";
    }

    document.addEventListener('DOMContentLoaded', function () {
        const totalSteps = 13; // Total number of steps
        const stepIndicatorsContainer = document.getElementById('stepIndicators');
        const carousel = document.getElementById('contractCarousel');

        // Generate step indicators with connecting lines
        for (let i = 1; i <= totalSteps; i++) {
            const indicator = document.createElement('span');
            indicator.classList.add('step-indicator');
            if (i === 1) indicator.classList.add('active'); // Mark the first step as active
            indicator.textContent = i;
            stepIndicatorsContainer.appendChild(indicator);
        }

        // Update indicators and lines when the carousel slides
        carousel.addEventListener('slid.bs.carousel', function (event) {
            const indicators = document.querySelectorAll('.step-indicator');
            const currentStep = event.to; // 0-based index of the current step

            // Reset all indicators
            indicators.forEach((indicator, index) => {
                indicator.classList.toggle('active', index <= currentStep);
            });
        });
    });

    document.querySelectorAll(".next-button").forEach((button) => {
        button.addEventListener("click", async function (event) {
            tinymce.triggerSave(); // Save TinyMCE content to its underlying <textarea>

            const form = document.getElementById("contractForm");
            const formData = new FormData(form);

            // Debug log for form data
            console.log("Form Data:");
            formData.forEach((value, key) => {
                console.log(`${key}: ${value}`);
            });

            if (contractId) {
                formData.append("id", contractId);
            }

            try {
                const response = await fetch("http://127.0.0.1:7000/api/contract-steps/", {
                    method: contractId ? "PUT" : "POST",
                    headers: {
                        "X-CSRFToken": getCSRFToken(),
                    },
                    body: formData,
                });

                if (response.ok) {
                    console.log("Update successful");
                } else {
                    console.error("Update failed");
                }
            } catch (error) {
                console.error("Unexpected error:", error);
            }
        });
    });

    document.getElementById("finalizeButton").addEventListener("click", async function (event) {
        event.preventDefault(); // Prevent immediate navigation
        tinymce.triggerSave(); // Save TinyMCE content to its underlying <textarea>

        const contractId = window.location.pathname.split("/")[2];
        const form = document.getElementById("contractForm");
        const formData = new FormData(form);

        try {
            // Send update request
            const response = await fetch(`http://127.0.0.1:7000/api/contract-steps-project-update/${contractId}/`, {
                method: "PUT",
                headers: {
                    "X-CSRFToken": getCSRFToken(),
                },
                body: formData,
            });

            if (response.ok) {
                console.log("Contract updated successfully");

                // Redirect after successful update
                window.location.href = `/contract-check-basis/${contractId}/`;
            } else {
                console.error("Failed to update contract");
                alert("Failed to update contract. Check console for details.");
            }
        } catch (error) {
            console.error("Unexpected error:", error);
            alert("An unexpected error occurred. Check console for details.");
        }
    });

    
// Update contract logic
document.getElementById("contractForm").addEventListener("submit", async function (event) {
    event.preventDefault(); // Prevent default form submission
    tinymce.triggerSave(); // Save all TinyMCE content to their underlying <textarea>

    const contractId = window.location.pathname.split("/")[2]; // Extract contract ID
    const form = document.getElementById("contractForm");
    const formData = new FormData(form); // Collect all form data, including TinyMCE content

    // List of text fields that need to be saved as empty if no content is present
    const textFields = ['purpose', 'obligations', 'payment_terms', 'termination_clause', 'confidentiality_clause', 'dispute_resolution', 'penalties_for_breach', 'notarization'];

    textFields.forEach(field => {
        const textArea = document.getElementById(field);
        if (textArea && textArea.value.trim() === '') {
            formData.set(field, ''); // Set the value to an empty string
        }
    });

    try {
        const response = await fetch(`http://127.0.0.1:7000/api/contract-steps-project-update/${contractId}/`, {
            method: "PUT", // Use PUT for updates
            headers: {
                "X-CSRFToken": getCSRFToken(), // Include CSRF token for Django
            },
            body: formData, // Send all form data
        });

        if (response.ok) {
            const data = await response.json();
            console.log("Contract updated successfully:", data);
            alert("Contract updated successfully!");
            window.location.href = `/contract-check-basis/${contractId}/`; // Redirect to the contract details page
        } else {
            const errorData = await response.json();
            console.error("Error updating contract:", errorData);
            alert("Failed to update contract. Check console for details.");
        }
    } catch (error) {
        console.error("Unexpected error updating contract:", error);
        alert("An unexpected error occurred. Check console for details.");
    }
});


document.addEventListener("DOMContentLoaded", function () {
    const urlParams = new URLSearchParams(window.location.search); // Parse query params
    const step = urlParams.get("step"); // Get the step parameter

    if (step) {
        const carousel = document.getElementById("contractCarousel");
        const carouselInstance = bootstrap.Carousel.getInstance(carousel) || new bootstrap.Carousel(carousel);

        // Navigate to the target step (zero-based index)
        carouselInstance.to(Number(step) - 1);
    }
});

document.addEventListener('DOMContentLoaded', function() {
    const notarizationToggle = document.getElementById('notarization_toggle'); // The toggle switch

    // The template for the notarization letter
    const notarizationTemplate = `
        <h1>Carta de Notarización</h1>

        <p><span class="section-title">Fecha:</span> [Insertar Fecha]</p>
        <p><span class="section-title">Lugar de Notarización:</span> [Insertar Ciudad, Estado, País]</p>

        <p>A quien corresponda,</p>

        <p>Yo, <strong>[Nombre del Notario Público]</strong>, Notario Público debidamente autorizado en la jurisdicción de <strong>[Ciudad, Estado, País]</strong>, certifico que el día <strong>[Insertar Día]</strong> de <strong>[Insertar Mes, Año]</strong>, compareció ante mí la(s) siguiente(s) persona(s):</p>

        <div class="id-block">
            <p><span class="id-label">Nombre Completo del Firmante 1:</span> [Insertar Nombre]</p>
            <p><span class="id-label">Tipo de Identificación/Número:</span> [Tipo de ID, ej. Pasaporte, Licencia de Conducir, etc.]</p>
            <p><span class="id-label">Número de ID:</span> [Insertar Número]</p>
            <p><span class="id-label">Firma:</span> _________________________</p>
        </div>

        <p>La(s) persona(s) mencionada(s) ha(n) demostrado su identidad de forma satisfactoria y ha(n) firmado voluntariamente el siguiente documento en mi presencia:</p>

        <p><span class="section-title">Título del Documento:</span> [Insertar Título del Documento, ej. Contrato de Servicios, Acuerdo de Bienes Raíces, Poder Notarial, etc.]</p>

        <p>El/los firmante(s) declaró/aron que ha(n) leído, comprendido y aceptado los términos y condiciones del documento antes mencionado. Con su firma, expresan su consentimiento libre y voluntario.</p>

        <p>Como Notario Público, certifico que he verificado la identidad de la(s) persona(s) y he presenciado su firma en el documento. Esta notarización se realiza conforme a las leyes y regulaciones aplicables de <strong>[Insertar País/Estado, ej. México]</strong> sobre la autenticación de documentos legales.</p>

        <p>Esta carta de notarización no certifica la legalidad, validez o contenido del documento, sino solo la identificación y la firma voluntaria de la(s) persona(s) comparecientes.</p>
    `;

    notarizationToggle.addEventListener('change', function() {
        controlVisibility();
    });

    function controlVisibility() {
        const editor = tinymce.get('notarization');
        if (editor) {
            const tinymceContainer = editor.getContainer();
            if (notarizationToggle.checked) {
                tinymceContainer.classList.remove('hidden');
                editor.setContent(notarizationTemplate); // Set the template in the TinyMCE editor
            } else {
                tinymceContainer.classList.add('hidden');
                editor.setContent(''); // Clear the content
            }
        } else {
            console.error('TinyMCE editor for #notarization not found.');
        }
    }

    tinymce.init({
        selector: '#notarization',
        plugins: 'advlist autolink lists link image charmap print preview anchor searchreplace visualblocks code fullscreen',
        toolbar: 'undo redo | formatselect | bold italic underline strikethrough | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent',
        menubar: 'file edit view insert format tools table help',
        setup: function (editor) {
            editor.on('init', function () {
                console.log('TinyMCE for notarization is ready');
                controlVisibility(); // Run visibility control once the editor is ready
            });
        }
    });
});

document.addEventListener('DOMContentLoaded', function () {
    const toggle = document.getElementById('confidentiality_toggle'); 
    const aiButton = document.getElementById('confidentiality_ai_button');
    const aiOutput = document.getElementById('confidentiality_clause-ai-output');
    const glassOverlay = document.getElementById('glass_overlay'); // The frosted glass overlay

    // Initial State: If toggle is unchecked, keep overlay and hide AI button & output
    if (!toggle.checked) {
        aiButton.classList.add('hidden');
        aiOutput.classList.add('hidden');
        glassOverlay.classList.remove('hidden'); // Show the glass overlay
        glassOverlay.classList.add('active'); // Activate click blocking
    }

    toggle.addEventListener('change', function () {
        const tinyMCEEditor = tinymce.get('confidentiality_clause'); // Get the TinyMCE editor instance
        if (toggle.checked) {
            aiButton.classList.remove('hidden');
            aiOutput.classList.remove('hidden');
            glassOverlay.classList.add('hidden'); // Hide the overlay, user can interact with TinyMCE
            glassOverlay.classList.remove('active'); // Remove the blocking state
        } else {
            aiButton.classList.add('hidden');
            aiOutput.classList.add('hidden');
            glassOverlay.classList.remove('hidden'); // Show the overlay
            glassOverlay.classList.add('active'); // Prevent user interaction
            
            // Clear the content of the TinyMCE editor
            if (tinyMCEEditor) {
                tinyMCEEditor.setContent(''); // Clear the editor content
            } else {
                console.warn('TinyMCE editor not found for #confidentiality_clause');
            }
        }
    });
});

document.addEventListener('DOMContentLoaded', function () {
    const toggle = document.getElementById('dispute_resolution_toggle'); 
    const aiButton = document.getElementById('dispute_resolution_ai_button');
    const aiOutput = document.getElementById('dispute_resolution-ai-output');
    const glassOverlay = document.getElementById('glass_overlay_dispute_resolution'); // The frosted glass overlay

    // Initial State: If toggle is unchecked, keep overlay and hide AI button & output
    if (!toggle.checked) {
        aiButton.classList.add('hidden');
        aiOutput.classList.add('hidden');
        glassOverlay.classList.remove('hidden'); // Show the glass overlay
        glassOverlay.classList.add('active'); // Activate click blocking
    }

    toggle.addEventListener('change', function () {
        const tinyMCEEditor = tinymce.get('dispute_resolution'); // Get the TinyMCE editor instance
        if (toggle.checked) {
            aiButton.classList.remove('hidden');
            aiOutput.classList.remove('hidden');
            glassOverlay.classList.add('hidden'); // Hide the overlay, user can interact with TinyMCE
            glassOverlay.classList.remove('active'); // Remove the blocking state
        } else {
            aiButton.classList.add('hidden');
            aiOutput.classList.add('hidden');
            glassOverlay.classList.remove('hidden'); // Show the overlay
            glassOverlay.classList.add('active'); // Prevent user interaction
            
            // Clear the content of the TinyMCE editor
            if (tinyMCEEditor) {
                tinyMCEEditor.setContent(''); // Clear the editor content
            } else {
                console.warn('TinyMCE editor not found for #dispute_resolution');
            }
        }
    });
});

document.addEventListener('DOMContentLoaded', function () {
    const toggle = document.getElementById('penalties_for_breach_toggle'); 
    const aiButton = document.getElementById('penalties_for_breach_ai_button');
    const aiOutput = document.getElementById('penalties_for_breach-ai-output');
    const glassOverlay = document.getElementById('glass_overlay_penalties_for_breach'); // The frosted glass overlay

    // Initial State: If toggle is unchecked, keep overlay and hide AI button & output
    if (!toggle.checked) {
        aiButton.classList.add('hidden');
        aiOutput.classList.add('hidden');
        glassOverlay.classList.remove('hidden'); // Show the glass overlay
        glassOverlay.classList.add('active'); // Activate click blocking
    }

    toggle.addEventListener('change', function () {
        const tinyMCEEditor = tinymce.get('penalties_for_breach'); // Get the TinyMCE editor instance
        if (toggle.checked) {
            aiButton.classList.remove('hidden');
            aiOutput.classList.remove('hidden');
            glassOverlay.classList.add('hidden'); // Hide the overlay, user can interact with TinyMCE
            glassOverlay.classList.remove('active'); // Remove the blocking state
        } else {
            aiButton.classList.add('hidden');
            aiOutput.classList.add('hidden');
            glassOverlay.classList.remove('hidden'); // Show the overlay
            glassOverlay.classList.add('active'); // Prevent user interaction
            
            // Clear the content of the TinyMCE editor
            if (tinyMCEEditor) {
                tinyMCEEditor.setContent(''); // Clear the editor content
            } else {
                console.warn('TinyMCE editor not found for #penalties_for_breach');
            }
        }
    });
});

</script>

{% endblock %}


